<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Music45</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <!-- Icons -->
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet" />
  <style>
    :root{
      --bg:#1c1c1c; --card:#2b2b2b; --accent:#ff4757; --accent-2:#e84118; --text:#fff; --muted:#bdbdbd;
    }
    *{box-sizing:border-box}
    body{
      margin:0; font-family:Arial, Helvetica, sans-serif; background:var(--bg); color:var(--text);
      padding-bottom:120px; /* leave room for footer player */
    }

    /* Header / Search */
    header{ display:flex; flex-direction:column; align-items:center; gap:8px; padding:20px 12px 8px;}
    header h1{ margin:0; font-size:24px; }
    .search-container{
      width:100%; max-width:900px; display:flex; gap:8px; padding:8px 12px 20px; justify-content:center; align-items:center;
    }
    .search-container input{
      flex:1; padding:12px 14px; border-radius:10px; border:1px solid #444; background:#111; color:var(--text);
      font-size:16px; outline:none;
    }
    .search-container button{
      padding:12px 16px; font-size:16px; border:none; background:var(--accent); color:#fff; cursor:pointer; border-radius:10px;
    }
    .search-container button:hover{ background:var(--accent-2); }

    /* Results list */
    #song-list{ width:100%; max-width:1000px; padding:0 12px 20px; }
    .song-item{
      display:flex; align-items:center; gap:14px; background:var(--card); border-radius:12px; padding:10px 12px; margin:10px auto;
      cursor:pointer; transition:transform .08s ease, background .2s ease; width:100%;
    }
    .song-item:hover{ transform:translateY(-1px); background:#333; }
    .song-item img{ width:72px; height:72px; border-radius:8px; object-fit:cover; flex-shrink:0; }
    .song-item .meta{ display:flex; flex-direction:column; gap:4px; overflow:hidden; }
    .song-item .title{ font-weight:700; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
    .song-item .artist{ color:var(--muted); font-size:14px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }

    /* Footer player (mini) */
    .footer-player{
      position:fixed; left:0; right:0; bottom:0; height:100px; background:#2f3542;
      display:flex; align-items:center; justify-content:space-between; padding:0 16px; z-index:1000;
      box-shadow:0 -6px 20px rgba(0,0,0,.25);
    }
    .footer-song-info{ display:flex; align-items:center; gap:12px; min-width:0; }
    #footer-cover{ width:60px; height:60px; border-radius:8px; object-fit:cover; background:#444; }
    .footer-song-text{ display:flex; flex-direction:column; min-width:0; }
    #footer-title{ font-weight:700; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
    #footer-artist{ color:var(--muted); font-size:13px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }

    .footer-controls{ display:flex; align-items:center; gap:10px; }
    .footer-controls .icon-btn{
      width:42px; height:42px; border-radius:50%; border:none; background:#3a4050; color:#fff; display:grid; place-items:center; cursor:pointer;
    }
    .footer-controls .icon-btn:hover{ background:#475067; }
    .footer-controls .toggle{
      border-radius:10px; padding:10px 12px; width:auto; height:auto;
    }

    /* Expanded banner player */
    .musicplayer{
      position:fixed; left:50%; transform:translateX(-50%);
      bottom:100px; /* sits above footer */
      width:min(900px, 94vw);
      background:#2f3542; color:#fff; border-top-left-radius:20px; border-top-right-radius:20px;
      padding:18px 18px 16px; z-index:999; display:none; box-shadow:0 10px 30px rgba(0,0,0,.35);
    }
    .banner-header{ display:flex; justify-content:space-between; align-items:center; margin-bottom:8px; }
    .banner-header .title-stack{ display:flex; gap:12px; align-items:center; min-width:0; }
    #banner-cover-image{ width:80px; height:80px; border-radius:10px; object-fit:cover; }
    .song-info{ display:flex; flex-direction:column; gap:6px; min-width:0; }
    #banner-song-title{ margin:0; font-size:18px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
    #banner-artist-name{ margin:0; color:#c9c9c9; font-size:14px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }

    .control-btn{
      background:none; border:none; color:#fff; font-size:20px; cursor:pointer; padding:8px; border-radius:10px;
    }
    .control-btn:hover{ background:#3a4050; }

    .progress-wrap{ padding:8px 0; }
    .progress-bar{
      width:100%; height:8px; background:#505663; border-radius:6px; position:relative; cursor:pointer;
    }
    .progress{ position:absolute; left:0; top:0; bottom:0; width:0%; background:var(--accent); border-radius:6px; }
    .time-stamps{ display:flex; justify-content:space-between; font-size:12px; color:#d8d8d8; margin-top:6px; }

    .main-controls{ display:flex; justify-content:center; gap:14px; margin:10px 0 4px; }
    .main-controls .pill{ background:#3a4050; border:none; color:#fff; padding:10px 12px; border-radius:12px; cursor:pointer; }
    .main-controls .pill:hover{ background:#4a5266; }

    audio{ display:none; }
    @media (max-width:520px){
      .song-item img{ width:60px; height:60px; }
      .footer-player{ height:90px; }
      #footer-cover{ width:52px; height:52px; }
    }
  </style>
</head>
<body>

  <header>
    <h1>ðŸŽµ Music45 â€“ JioSaavn</h1>
    <div class="search-container">
      <input id="search-query" placeholder="Search song..." />
      <button id="search-btn">Search</button>
    </div>
  </header>

  <div id="song-list"></div>

  <!-- Footer mini-player -->
  <div class="footer-player">
    <div class="footer-song-info">
      <img id="footer-cover" src="https://via.placeholder.com/60x60?text=ðŸŽµ" alt="cover" />
      <div class="footer-song-text">
        <div id="footer-title">No Song</div>
        <div id="footer-artist">---</div>
      </div>
    </div>
    <div class="footer-controls">
      <button class="icon-btn" id="prev"><i class="fa-solid fa-backward"></i></button>
      <button class="icon-btn" id="playPause"><i id="playPauseIcon" class="fa-solid fa-play"></i></button>
      <button class="icon-btn" id="next"><i class="fa-solid fa-forward"></i></button>
      <button class="icon-btn toggle" id="footerToggleBtn" title="Expand"><i class="fa-solid fa-chevron-up"></i></button>
    </div>
  </div>

  <!-- Expanded banner player -->
  <div id="musicbanner" class="musicplayer">
    <div class="banner-header">
      <div class="title-stack">
        <img id="banner-cover-image" src="https://via.placeholder.com/80x80?text=ðŸŽµ" alt="cover"/>
        <div class="song-info">
          <h2 id="banner-song-title">Title</h2>
          <p id="banner-artist-name">Artist</p>
        </div>
      </div>
      <button id="close-banner-btn" class="control-btn" title="Collapse">
        <i class="fa-solid fa-chevron-down"></i>
      </button>
    </div>

    <div class="progress-wrap">
      <div class="progress-bar" id="progress-bar"><div id="progress" class="progress"></div></div>
      <div class="time-stamps"><span id="current-time">00:00</span><span id="duration">00:00</span></div>
    </div>

    <div class="main-controls">
      <button id="shuffle-btn" class="pill"><i class="fa-solid fa-shuffle"></i> Shuffle</button>
      <button id="banner-prev" class="pill"><i class="fa-solid fa-backward"></i></button>
      <button id="banner-play-pause" class="pill"><i class="fa-solid fa-play"></i></button>
      <button id="banner-next" class="pill"><i class="fa-solid fa-forward"></i></button>
      <button id="repeat-btn" class="pill"><i class="fa-solid fa-repeat"></i> Repeat</button>
    </div>
  </div>

  <!-- Hidden audio -->
  <audio id="audio"></audio>

  <script>
    // ====== State ======
    const audio = document.getElementById('audio');
    let songQueue = [];          // [{id,title,artist,cover,url?:string|null}]
    let currentSongIndex = 0;
    let shuffleMode = false;
    let repeatMode = false;
    let isPlaying = false;

    // ====== Utils ======
    const $ = (id) => document.getElementById(id);
    const fmt = (sec)=> {
      if (!isFinite(sec)) return '00:00';
      const m = Math.floor(sec/60);
      const s = Math.floor(sec%60);
      return `${String(m).padStart(2,'0')}:${String(s).padStart(2,'0')}`;
    };
    const pickLargest = (arr, key='link') =>
      Array.isArray(arr) && arr.length ? (arr[arr.length-1][key] || arr[arr.length-1]) : '';

    // Try to extract the best playable URL from a Saavn song object
    function extractPlayableUrl(song) {
      // Prefer highest quality from downloadUrl
      const dl = Array.isArray(song?.downloadUrl) ? song.downloadUrl : song?.download_url;
      let url = Array.isArray(dl) && dl.length ? dl[dl.length-1]?.link || dl[dl.length-1]?.url : null;
      // Fallbacks seen in some wrappers
      if (!url && song?.media_url) url = song.media_url;
      if (!url && song?.url) url = song.url;
      return url || null;
    }

    // ====== UI update ======
    function updateUI(meta){
      // footer
      $('footer-cover').src = meta.cover || 'https://via.placeholder.com/60x60?text=ðŸŽµ';
      $('footer-title').textContent = meta.title || 'No Song';
      $('footer-artist').textContent = meta.artist || '---';
      // banner
      $('banner-cover-image').src = meta.cover || 'https://via.placeholder.com/80x80?text=ðŸŽµ';
      $('banner-song-title').textContent = meta.title || 'Title';
      $('banner-artist-name').textContent = meta.artist || 'Artist';
      // buttons
      $('playPauseIcon').className = isPlaying ? 'fa-solid fa-pause' : 'fa-solid fa-play';
      $('banner-play-pause').innerHTML = `<i class="fa-solid ${isPlaying?'fa-pause':'fa-play'}"></i>`;
    }

    function updateProgress(){
      $('current-time').textContent = fmt(audio.currentTime || 0);
      $('duration').textContent = fmt(audio.duration || 0);
      const pct = (audio.currentTime && audio.duration) ? (audio.currentTime / audio.duration) * 100 : 0;
      $('progress').style.width = `${pct}%`;
    }

    // ====== Media Session for background controls ======
    function setMediaSession(meta){
      if (!('mediaSession' in navigator)) return;
      navigator.mediaSession.metadata = new MediaMetadata({
        title: meta.title,
        artist: meta.artist,
        artwork: meta.cover ? [{src: meta.cover, sizes:'512x512', type:'image/png'}] : []
      });
      navigator.mediaSession.setActionHandler('play',  () => togglePlay(true));
      navigator.mediaSession.setActionHandler('pause', () => togglePlay(false));
      navigator.mediaSession.setActionHandler('previoustrack', prevSong);
      navigator.mediaSession.setActionHandler('nexttrack', nextSong);
      navigator.mediaSession.setActionHandler('seekto', (details) => {
        if (details.fastSeek && 'fastSeek' in audio) audio.fastSeek(details.seekTime);
        else audio.currentTime = details.seekTime;
      });
    }

    // ====== Search (JioSaavn) ======
    async function searchSongs(){
      const q = $('search-query').value.trim();
      if (!q) return alert('Enter song!');
      $('song-list').innerHTML = 'Searching...';

      try{
        const res = await fetch(`https://saavn.dev/api/search/songs?query=${encodeURIComponent(q)}`);
        const data = await res.json();
        const results = data?.data?.results || [];
        if (!results.length){
          $('song-list').innerHTML = '<div style="opacity:.8">No results</div>';
          return;
        }

        // Build queue (URLs loaded lazily on play)
        songQueue = results.map(s => ({
          id: s.id,
          title: s.name,
          artist: s.primaryArtists,
          cover: pickLargest(s?.image, 'link'),
          url: null
        }));

        renderResults(songQueue);
      } catch(err){
        console.error(err);
        $('song-list').innerHTML = '<div style="opacity:.8">Error fetching results</div>';
      }
    }

    function renderResults(items){
      const container = $('song-list');
      container.innerHTML = '';
      items.forEach((s, i) => {
        const div = document.createElement('div');
        div.className = 'song-item';
        div.innerHTML = `
          <img src="${s.cover || 'https://via.placeholder.com/72x72?text=ðŸŽµ'}" alt="cover">
          <div class="meta">
            <div class="title">${s.title}</div>
            <div class="artist">${s.artist || ''}</div>
          </div>
        `;
        div.onclick = () => playIndex(i);
        container.appendChild(div);
      });
    }

    // ====== Playback ======
    async function ensureUrlLoaded(index){
      const s = songQueue[index];
      if (s.url) return s.url;
      try{
        const res = await fetch(`https://saavn.dev/api/songs?ids=${encodeURIComponent(s.id)}`);
        const data = await res.json();
        const full = data?.data?.[0];
        const url = extractPlayableUrl(full);
        if (url){
          s.url = url;
          // update cover/title/artist if better fields exist
          s.cover = s.cover || pickLargest(full?.image, 'link');
          s.title = s.title || full?.name || '';
          s.artist = s.artist || full?.primaryArtists || '';
        }
        return s.url || null;
      }catch(err){
        console.error('Failed to load song url', err);
        return null;
      }
    }

    async function playIndex(index){
      if (index < 0 || index >= songQueue.length) return;
      currentSongIndex = index;
      const s = songQueue[index];

      const url = await ensureUrlLoaded(index);
      if (!url){
        alert('No playable URL found for this song.');
        return;
      }

      audio.src = url;
      audio.play().catch(()=>{ /* autoplay block */ });
      isPlaying = true;
      updateUI(s);
      setMediaSession(s);
    }

    function togglePlay(shouldPlay){
      if (typeof shouldPlay === 'boolean'){
        if (shouldPlay) audio.play(); else audio.pause();
      }else{
        if (audio.paused) audio.play(); else audio.pause();
      }
    }

    function nextSong(){
      if (!songQueue.length) return;
      if (shuffleMode){
        let n = Math.floor(Math.random()*songQueue.length);
        if (songQueue.length > 1 && n === currentSongIndex){
          n = (n+1) % songQueue.length;
        }
        playIndex(n);
      }else{
        const n = (currentSongIndex + 1) % songQueue.length;
        playIndex(n);
      }
    }
    function prevSong(){
      if (!songQueue.length) return;
      const n = (currentSongIndex - 1 + songQueue.length) % songQueue.length;
      playIndex(n);
    }

    // ====== Events / Wiring ======
    $('search-btn').addEventListener('click', searchSongs);
    $('search-query').addEventListener('keydown', (e)=>{ if(e.key==='Enter') searchSongs(); });

    // Footer buttons
    $('prev').addEventListener('click', prevSong);
    $('next').addEventListener('click', nextSong);
    $('playPause').addEventListener('click', ()=> togglePlay());

    // Banner buttons mirror footer
    $('banner-prev').addEventListener('click', prevSong);
    $('banner-next').addEventListener('click', nextSong);
    $('banner-play-pause').addEventListener('click', ()=> togglePlay());

    // Expand/Collapse banner
    $('footerToggleBtn').addEventListener('click', ()=>{
      const b = $('musicbanner');
      b.style.display = (b.style.display === 'block') ? 'none' : 'block';
    });
    $('close-banner-btn').addEventListener('click', ()=> $('musicbanner').style.display='none');

    // Audio events
    audio.addEventListener('play', ()=>{
      isPlaying = true;
      $('playPauseIcon').className = 'fa-solid fa-pause';
      $('banner-play-pause').innerHTML = '<i class="fa-solid fa-pause"></i>';
    });
    audio.addEventListener('pause', ()=>{
      isPlaying = false;
      $('playPauseIcon').className = 'fa-solid fa-play';
      $('banner-play-pause').innerHTML = '<i class="fa-solid fa-play"></i>';
    });
    audio.addEventListener('timeupdate', updateProgress);
    audio.addEventListener('loadedmetadata', updateProgress);
    audio.addEventListener('ended', ()=>{
      if (repeatMode){
        audio.currentTime = 0; audio.play();
      } else {
        nextSong();
      }
    });

    // Seek via progress bar
    $('progress-bar').addEventListener('click', (e)=>{
      const rect = e.currentTarget.getBoundingClientRect();
      const pct = (e.clientX - rect.left) / rect.width;
      if (isFinite(audio.duration)) audio.currentTime = audio.duration * pct;
    });

    // Shuffle / Repeat toggles
    $('shuffle-btn').addEventListener('click', ()=>{
      shuffleMode = !shuffleMode;
      alert('Shuffle is ' + (shuffleMode ? 'ON' : 'OFF'));
    });
    $('repeat-btn').addEventListener('click', ()=>{
      repeatMode = !repeatMode;
      alert('Repeat is ' + (repeatMode ? 'ON' : 'OFF'));
    });

    // Optional: preload a demo search
    // searchSongs();
  </script>
</body>
</html>
