<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Music45 YouTube Search</title>
  <style>
    body { font-family: Arial, sans-serif; background: #111; color: #fff; text-align: center; }
    #results { margin-top: 20px; display: grid; grid-template-columns: repeat(auto-fill, minmax(250px, 1fr)); gap: 15px; }
    .video-card { background: #222; padding: 10px; border-radius: 8px; box-shadow: 0 0 10px #444; }
    .video-card img { width: 100%; border-radius: 8px; }
    .video-title { font-size: 14px; margin-top: 8px; }
  </style>
</head>
<body>
  <h2>ðŸŽµ Music45 YouTube Search</h2>
  <input type="text" id="searchBox" placeholder="Search songs..." style="padding:10px; width:60%;">
  <button onclick="handleSearch()">Search</button>
  <div id="results"></div>

  <script>
    // ðŸš€ 1. Multiple API Keys (Add more keys here)
    const API_KEYS = [
      "AIzaSyAwKYDbklOiCO1o3Dr7uM-xISbjksPkgDk",
      "AIzaSyCwFRzcS_3E_ADULIdtesolIbbD5YD8Sgs",
      "61036401f4msh42afa629c15c59bp1de3a8jsn9b9bfc7bc873"
    ];
    let currentKeyIndex = 0;

    function getApiKey() {
      return API_KEYS[currentKeyIndex];
    }

    function switchKey() {
      currentKeyIndex = (currentKeyIndex + 1) % API_KEYS.length;
      console.log("Switched to API key:", currentKeyIndex);
    }

    // ðŸš€ 2. Cache System
    const CACHE_EXPIRY = 24 * 60 * 60 * 1000; // 24h

    function setCache(query, data) {
      const item = { data, timestamp: Date.now() };
      localStorage.setItem("cache_" + query, JSON.stringify(item));
    }

    function getCache(query) {
      const item = localStorage.getItem("cache_" + query);
      if (!item) return null;
      const parsed = JSON.parse(item);
      if (Date.now() - parsed.timestamp > CACHE_EXPIRY) {
        localStorage.removeItem("cache_" + query);
        return null;
      }
      return parsed.data;
    }

    // ðŸš€ 3. YouTube Search Function (with rotation + cache)
    async function searchYouTube(query) {
      // 1. Try Cache First
      const cached = getCache(query);
      if (cached) {
        console.log("Loaded from cache:", query);
        return cached;
      }

      // 2. API Request with rotation
      let attempts = 0;
      while (attempts < API_KEYS.length) {
        const apiKey = getApiKey();
        const url = `https://www.googleapis.com/youtube/v3/search?part=snippet&type=video&q=${encodeURIComponent(query)}&maxResults=8&key=${apiKey}`;

        try {
          const res = await fetch(url);
          const data = await res.json();

          if (data.error) {
            console.warn("API Error:", data.error.message);
            switchKey(); // Try next key
            attempts++;
          } else if (data.items) {
            setCache(query, data.items);
            return data.items;
          } else {
            return [];
          }
        } catch (err) {
          console.error("Fetch Error:", err);
          switchKey();
          attempts++;
        }
      }

      return []; // If all keys fail
    }

    // ðŸš€ 4. Handle Search + Show Results
    async function handleSearch() {
      const query = document.getElementById("searchBox").value.trim();
      if (!query) return;

      document.getElementById("results").innerHTML = "<p>Loading...</p>";

      const items = await searchYouTube(query);

      if (items.length === 0) {
        document.getElementById("results").innerHTML = "<p>No results found or quota exceeded.</p>";
        return;
      }

      document.getElementById("results").innerHTML = items.map(video => `
        <div class="video-card">
          <a href="https://www.youtube.com/watch?v=${video.id.videoId}" target="_blank">
            <img src="${video.snippet.thumbnails.medium.url}" alt="${video.snippet.title}">
          </a>
          <div class="video-title">${video.snippet.title}</div>
        </div>
      `).join("");
    }
  </script>
</body>
</html>
